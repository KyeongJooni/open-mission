## 오픈미션: 테스트 커버리지 90% 달성

### 배경 및 목적

#### 왜 이 미션을 선택했는가

이 프로젝트는 프리코스와 병행하였던 동아리 개인 과제 블로그 프로젝트다. 프리코스와 진행하면서 얻은 인사이트를 실제 프로젝트에 적용해보고 싶었다.

**새로운 도전**

지금까지 테스트 커버리지를 50%를 넘긴 적이 없었다. 프리코스를 진행하면서 단위 테스트를 도입하는 것에 익숙해졌고, 이번 기회에 90%라는 높은 목표를 잡고 도전해보려 한다. 또한 E2E 테스트(Cypress)와 MSW를 활용한 API 모킹 테스트는 처음 시도하는 영역이다.

테스트 코드 작성은 첫 번째 단계이며, 이후 성능 최적화와 접근성 개선 등 단계적 품질 개선을 계획하고 있다.

#### 왜 테스트를 보강하는가

프리코스 3주 동안 핵심 학습 목표 중 하나는 **"단위 테스트를 통해 코드를 구조적으로 사고하는 것"**이었다. 그러나 현재 프로젝트의 테스트 커버리지는 약 5%에 불과하며, 이는 다음과 같은 문제점을 야기한다.

**1. 코드 변경에 대한 자신감 부족**

테스트가 없는 코드는 수정할 때마다 "다른 곳이 깨지진 않을까?"라는 불안감을 동반한다. 특히 `blogContentParser`, `apiInstance`와 같은 핵심 모듈은 여러 컴포넌트에서 사용되므로, 한 곳의 수정이 전체에 영향을 미칠 수 있다. 테스트가 있다면 코드를 수정한 후 테스트를 실행하여 기존 기능이 정상 동작하는지 즉시 확인할 수 있다.

**2. 예외 상황 처리의 부재**

3주차 피드백에서 강조한 것처럼, "정상적인 상황을 구현하는 것보다 예외 상황을 모두 고려하여 프로그래밍하는 것이 훨씬 어렵다." 현재 코드에는 다음과 같은 예외 상황에 대한 처리가 미흡하다.

- API 요청 실패 시 사용자에게 보여줄 에러 메시지
- 토큰 만료 시 자동 갱신 실패 케이스
- 잘못된 입력값에 대한 경계값 처리
- 네트워크 끊김 상황

테스트를 작성하면서 이러한 예외 상황을 체계적으로 발견하고 처리할 수 있다.

**3. 리팩토링의 안전장치**

3주차 피드백에서 "함수가 15라인을 초과한다면, 역할을 더 명확하게 나누고 함수 분리를 고려해야 한다"고 했다. 현재 프로젝트에는 15라인을 초과하는 함수들이 존재하며, 이를 분리하려면 기존 동작이 유지되는지 검증할 방법이 필요하다. 테스트는 리팩토링의 안전장치 역할을 한다.

**4. 비즈니스 로직과 UI 로직 분리 검증**

3주차 피드백에서 "비즈니스 로직과 UI 로직을 한 클래스에서 처리하는 것은 단일 책임 원칙(SRP)에 위배된다"고 했다. 현재 일부 컴포넌트에는 비즈니스 로직이 섞여 있어 테스트하기 어렵다. 테스트를 작성하면서 이러한 결합을 발견하고 분리할 수 있다.

**5. 문서화 역할**

잘 작성된 테스트 코드는 그 자체로 문서가 된다. 테스트 케이스를 보면 해당 함수나 컴포넌트가 어떤 입력을 받고, 어떤 출력을 내는지, 어떤 예외 상황을 처리하는지 파악할 수 있다. 이는 2주차 피드백에서 강조한 "살아있는 문서"의 역할을 한다.

#### 기대 효과

1. **버그 사전 발견**: 프로덕션 배포 전에 문제를 발견
2. **개발 속도 향상**: 수동 테스트 시간 단축
3. **코드 품질 향상**: 테스트하기 쉬운 코드 = 좋은 구조의 코드
4. **협업 용이성**: 다른 개발자가 코드를 이해하기 쉬움
5. **자신감 있는 배포**: 변경 사항이 기존 기능을 깨뜨리지 않음을 보장

<br>

### 현재 상태 분석

| 항목 | 현재 | 목표 |
|------|------|------|
| 테스트 커버리지 | 5.2% | 90%+ |
| Statements | 116/2230 | 2000+ |
| Branches | 47/724 | 650+ |
| Functions | 28/507 | 450+ |
| Lines | 103/2016 | 1800+ |

**현재 테스트된 영역:**
- 유틸 함수 일부 (validation, date, textFormatter, profileHelpers, blogContentParser)

**테스트되지 않은 영역:**
- Zustand 스토어 (4개)
- 커스텀 훅 (17개 중 1개만 테스트)
- API 레이어 (5개 모듈)
- 컴포넌트 (대부분 미테스트)
- E2E 테스트 (전무)

<br>

### 상세 구현 계획

---

#### 1단계: 테스트 환경 설정

**목표:** 테스트 실행 환경을 완벽하게 구성

**작업 내용:**

1. 의존성 설치
   - `@testing-library/dom` - React Testing Library 필수 의존성
   - `msw` - API 모킹을 위한 Mock Service Worker
   - `cypress` - E2E 테스트 프레임워크

2. Jest 설정 보완
   - `setupFilesAfterEnv` 설정 추가
   - 전역 모킹 설정 (localStorage, sessionStorage, IntersectionObserver)
   - 테스트 타임아웃 설정

3. 테스트 유틸리티 작성
   - 커스텀 render 함수 (Provider 래핑)
   - React Query 테스트 유틸리티
   - Zustand 스토어 리셋 유틸리티

**완료 기준:**
- 모든 기존 테스트가 통과
- 컴포넌트/훅 테스트 실행 가능

**커밋:** `chore(test): configure test environment and install dependencies`

---

#### 2단계: 단위 테스트 - 유틸 함수 확대

**목표:** 모든 유틸 함수에 대한 테스트 작성

**프리코스 피드백 적용:**
- 2주차: "정상적인 경우뿐만 아니라 예외 상황도 함께 정리한다."
- 3주차: "예외 상황을 모두 고려하여 프로그래밍하는 것이 훨씬 어렵다."

**테스트 대상 및 케이스:**

1. `blogContentConverter.ts`
   - 정상: API 응답을 에디터 형식으로 변환
   - 정상: TEXT, IMAGE, MARKDOWN 타입별 처리
   - 예외: 빈 배열 입력
   - 예외: 잘못된 contentType
   - 예외: null/undefined content

2. `blogContentExtractor.ts`
   - 정상: 첫 번째 텍스트 추출
   - 정상: 첫 번째 이미지 URL 추출
   - 예외: 콘텐츠가 없는 경우
   - 예외: 텍스트만 있는 경우 이미지 추출
   - 예외: 이미지만 있는 경우 텍스트 추출

3. `markdownDetector.ts`
   - 정상: 마크다운 문법 감지 (헤더, 볼드, 이탤릭, 링크, 코드블록)
   - 예외: 일반 텍스트
   - 예외: 빈 문자열
   - 예외: HTML 태그

4. `cn.ts`
   - 정상: 클래스 병합
   - 정상: 조건부 클래스
   - 예외: undefined/null 입력

5. `schemas.ts`
   - 정상: 모든 스키마 검증
   - 예외: 비밀번호 불일치 (refine)

**완료 기준:**
- 유틸 함수 커버리지 95% 이상
- 모든 예외 케이스 테스트

**커밋:** `test(utils): add comprehensive unit tests for utility functions`

---

#### 3단계: 단위 테스트 - Zustand 스토어

**목표:** 모든 상태 관리 로직 테스트

**프리코스 피드백 적용:**
- 3주차: "비즈니스 로직과 UI 로직의 분리한다"

스토어는 비즈니스 로직을 담당하므로, UI와 독립적으로 테스트 가능해야 한다.

**테스트 대상:**

1. `useAuthStore`
   - 정상: 로그인 상태 설정/해제
   - 정상: 카카오 사용자 플래그 설정
   - 정상: 토큰 저장/삭제
   - 예외: 토큰 없이 인증 상태 확인

2. `useBlogWriteStore`
   - 정상: 제목 설정
   - 정상: 콘텐츠 설정 (기본/마크다운)
   - 정상: 에디터 모드 전환
   - 정상: 수정 모드 ID 설정
   - 정상: 상태 초기화
   - 예외: 모드 전환 시 콘텐츠 유지 확인

3. `useEditModeStore`
   - 정상: 수정 모드 활성화/비활성화
   - 정상: 수정할 데이터 설정

4. `useModalStore`
   - 정상: 모달 열기/닫기
   - 정상: 모달 타입 설정
   - 예외: 여러 모달 동시 열기 방지

**완료 기준:**
- 스토어 커버리지 100%
- 상태 변화 시나리오 모두 테스트

**커밋:** `test(stores): add unit tests for all Zustand stores`

---

#### 4단계: 단위 테스트 - 커스텀 훅

**목표:** 17개 커스텀 훅에 대한 테스트 작성

**프리코스 피드백 적용:**
- 3주차: "함수가 15라인을 초과한다면, 역할을 더 명확하게 나누고 함수 분리를 고려해야 한다."

복잡한 훅은 테스트 작성 시 분리가 필요한지 검토한다.

**테스트 대상 (우선순위순):**

높은 우선순위 (핵심 비즈니스 로직):

1. `useInfiniteScroll`
   - 정상: 초기 데이터 로드
   - 정상: 다음 페이지 로드 (fetchNextPage)
   - 정상: 마지막 페이지 도달 시 중단
   - 예외: 로딩 중 중복 요청 방지
   - 예외: 에러 발생 시 처리

2. `useBlogWrite`
   - 정상: 게시물 생성
   - 정상: 게시물 수정
   - 정상: 에디터 모드 전환
   - 정상: 이미지 업로드 연동
   - 예외: 빈 제목으로 저장 시도
   - 예외: 네트워크 에러

3. `useBlogComment`
   - 정상: 댓글 작성
   - 정상: 댓글 수정
   - 정상: 댓글 삭제
   - 예외: 권한 없는 댓글 수정/삭제
   - 예외: 빈 댓글 작성

4. `useS3ImageUpload`
   - 정상: Presigned URL 요청
   - 정상: S3 업로드
   - 정상: 업로드 완료 후 URL 반환
   - 예외: 파일 크기 초과
   - 예외: 지원하지 않는 파일 형식
   - 예외: 네트워크 에러

5. `useSignup`
   - 정상: 회원가입 성공
   - 정상: 카카오 회원가입 (추가 정보 입력)
   - 예외: 이메일 중복
   - 예외: 닉네임 중복
   - 예외: 유효성 검사 실패

6. `useLoginForm`
   - 정상: 로그인 성공
   - 정상: 토큰 저장
   - 예외: 잘못된 이메일/비밀번호
   - 예외: 계정 없음

7. `useKakaoCallback`
   - 정상: 기존 사용자 로그인
   - 정상: 신규 사용자 회원가입 유도
   - 예외: 잘못된 인가 코드

중간 우선순위:

8. `useEditProfile` - 프로필 정보 수정
9. `useMyPage` - 사용자 정보 조회
10. `useImageUpload` - 에디터 이미지 삽입
11. `useMediaQuery` - 미디어 쿼리 매칭

낮은 우선순위 (UI 유틸리티):

12. `useBodyScrollLock` - 스크롤 잠금/해제
13. `useFocusTrap` - 포커스 트랩
14. `useSidebar` - 사이드바 토글
15. `useDetailTypeHeader` - 헤더 타입
16. `usePageHeaderType` - 페이지 헤더
17. `useWriteTypeHeader` - 작성 페이지 헤더

**완료 기준:**
- 높은 우선순위 훅 커버리지 90% 이상
- 모든 훅 최소 기본 테스트 작성

**커밋:**
- `test(hooks): add unit tests for core business hooks`
- `test(hooks): add unit tests for form and page hooks`
- `test(hooks): add unit tests for UI utility hooks`

---

#### 5단계: 통합 테스트 - API 레이어

**목표:** MSW를 활용한 API 통합 테스트

**프리코스 피드백 적용:**
- 3주차: "예상되는 예외를 미리 고려하여, 프로그램이 비정상적으로 종료되거나 잘못된 결과를 내지 않도록 한다."

**MSW 설정:**
1. 핸들러 정의 (모든 API 엔드포인트)
2. 서버 설정 (setupServer)
3. 테스트 환경 통합

**테스트 대상:**

1. `authApi`
   - 정상: 회원가입 (201)
   - 정상: 로그인 (200)
   - 정상: 토큰 갱신 (200)
   - 정상: 로그아웃 (200)
   - 정상: 카카오 OAuth (200, 401)
   - 예외: 잘못된 자격 증명 (401)
   - 예외: 이메일/닉네임 중복 (409)
   - 예외: 서버 에러 (500)

2. `blogApi`
   - 정상: 게시물 목록 조회 (페이지네이션)
   - 정상: 게시물 상세 조회
   - 정상: 게시물 생성/수정/삭제
   - 예외: 존재하지 않는 게시물 (404)
   - 예외: 권한 없음 (403)

3. `commentApi`
   - 정상: 댓글 CRUD
   - 예외: 존재하지 않는 게시물/댓글
   - 예외: 권한 없음

4. `userApi`
   - 정상: 사용자 정보 조회/수정
   - 예외: 닉네임 중복

5. `imageApi`
   - 정상: Presigned URL 발급
   - 예외: 잘못된 파일명

6. 토큰 관리 (apiInstance)
   - 정상: 요청 시 Authorization 헤더 추가
   - 정상: 401 에러 시 토큰 갱신 후 재요청
   - 예외: 갱신 실패 시 로그아웃

**완료 기준:**
- API 레이어 커버리지 90% 이상
- 모든 HTTP 상태 코드 테스트
- 에러 핸들링 검증

**커밋:**
- `test(api): configure MSW and add mock handlers`
- `test(api): add integration tests for auth API`
- `test(api): add integration tests for blog and comment APIs`
- `test(api): add integration tests for user and image APIs`

---

#### 6단계: 컴포넌트 테스트

**목표:** 사용자 인터랙션을 포함한 컴포넌트 테스트

**프리코스 피드백 적용:**
- 3주차: "비즈니스 로직과 UI 로직을 한 클래스에서 처리하는 것은 단일 책임 원칙(SRP)에 위배된다."

컴포넌트는 UI 로직만 테스트하고, 비즈니스 로직은 훅/스토어 테스트에서 검증한다.

**테스트 대상:**

1. 폼 컴포넌트 (높은 우선순위)
   - `LoginForm`: 입력, 유효성 검사, 제출
   - `SignupForm`: 다단계 입력, 유효성 검사

2. 블로그 컴포넌트
   - `PostCard`: 렌더링, 클릭 이벤트
   - `Comment`: 작성, 수정, 삭제 버튼

3. 공통 컴포넌트
   - `Modal`: 열기/닫기, 외부 클릭
   - `Toast`: 표시/숨김, 타입별 스타일
   - `Pagination`: 페이지 이동
   - `TextField`: 입력, 에러 표시
   - `Button`: 클릭, disabled 상태

**테스트 방법:**
- `@testing-library/react`의 `render`, `screen`, `userEvent` 활용
- 접근성 쿼리 우선 사용 (getByRole, getByLabelText)
- 사용자 관점에서 테스트

**완료 기준:**
- 폼 컴포넌트 커버리지 90% 이상
- 사용자 인터랙션 시나리오 테스트

**커밋:**
- `test(components): add tests for form components`
- `test(components): add tests for blog components`
- `test(components): add tests for common UI components`

---

#### 7단계: E2E 테스트 (Cypress)

**목표:** 전체 사용자 플로우 테스트

**프리코스 피드백 적용:**
- 1주차: "요구 사항을 정확하게 준수한다"

E2E 테스트로 모든 기능 요구사항이 정상 동작하는지 검증한다.

**Cypress 설정:**
1. 설치 및 기본 설정
2. 커스텀 커맨드 작성 (로그인, 회원가입)
3. 테스트 데이터 fixtures

**테스트 시나리오:**

1. 인증 플로우
   - 회원가입 (이메일, 프로필 이미지 업로드)
   - 로그인/로그아웃
   - 카카오 OAuth (모킹)

2. 게시물 플로우
   - 게시물 목록 조회 (무한 스크롤)
   - 게시물 상세 조회
   - 게시물 작성 (기본 에디터)
   - 게시물 작성 (마크다운 에디터)
   - 이미지 업로드
   - 게시물 수정
   - 게시물 삭제

3. 댓글 플로우
   - 댓글 작성
   - 댓글 수정
   - 댓글 삭제

4. 프로필 플로우
   - 프로필 조회
   - 닉네임 수정
   - 프로필 이미지 변경
   - 한 줄 소개 수정

5. 예외 상황 (3주차 피드백)
   - 로그인 없이 글 작성 시도 → 로그인 유도
   - 권한 없는 글/댓글 수정 시도 → 에러 메시지
   - 네트워크 에러 → 재시도 안내

**완료 기준:**
- 모든 기능 요구사항 E2E 테스트 완료
- CI/CD 파이프라인 연동 가능

**커밋:**
- `test(e2e): configure Cypress and add custom commands`
- `test(e2e): add authentication flow tests`
- `test(e2e): add blog post flow tests`
- `test(e2e): add comment and profile flow tests`

---

#### 8단계: 코드 품질 개선

**목표:** 테스트 작성 중 발견된 문제점 개선

**3주차 피드백 전면 적용:**

1. 함수 15라인 제한
   - 테스트하기 어려운 긴 함수 식별
   - 책임 분리하여 함수 분리
   - 각 함수에 대한 개별 테스트 작성

2. 비즈니스/UI 로직 분리
   - 컴포넌트 내 비즈니스 로직 → 훅으로 이동
   - 순수 UI 컴포넌트로 리팩토링
   - 테스트 용이성 확보

3. 예외 상황 처리 강화
   - 테스트에서 발견된 미처리 예외 수정
   - 에러 바운더리 활용
   - 사용자 친화적 에러 메시지

**2주차 피드백 적용:**

4. 상수 사용
   - 하드코딩된 값 → 상수로 추출
   - 테스트에서 상수 재사용

**리팩토링 대상 (예상):**
- `useBlogWrite.ts` - 복잡한 상태 관리 로직
- `apiInstance.ts` - 인터셉터 로직
- `blogContentParser` - 파싱 로직

**완료 기준:**
- 모든 함수 15라인 이하
- 테스트 커버리지 영향 없이 리팩토링 완료

**커밋:**
- `refactor(hooks): split complex hook functions for testability`
- `refactor(api): separate interceptor logic`
- `refactor(utils): improve parser function structure`

<br>

### 기술 스택 (테스트)

| 도구 | 용도 | 버전 |
|------|------|------|
| Jest | 테스트 러너 | 30.x |
| React Testing Library | 컴포넌트 테스트 | 16.x |
| MSW | API 모킹 | 2.x |
| Cypress | E2E 테스트 | 13.x |

<br>

### 커밋 컨벤션 (Angular Style)

```
<type>(<scope>): <subject>

<body>

<footer>
```

**Type**

| 타입 | 설명 |
|------|------|
| `test` | 테스트 코드 추가/수정 |
| `feat` | 새로운 기능 추가 |
| `fix` | 버그 수정 |
| `refactor` | 코드 리팩토링 (기능 변화 없음) |
| `chore` | 빌드, 설정 파일 수정 |
| `docs` | 문서 수정 |

**Scope (범위)**
- `test`: 테스트 환경 설정
- `utils`: 유틸 함수
- `stores`: Zustand 스토어
- `hooks`: 커스텀 훅
- `api`: API 레이어
- `components`: 컴포넌트
- `e2e`: E2E 테스트

**예시**
```
test(hooks): add unit tests for useInfiniteScroll

- 초기 데이터 로드 테스트
- 페이지네이션 동작 테스트
- 에러 핸들링 테스트
- 커버리지 85% 달성

Refs: #123
```

<br>

### 진행 상황 추적

| 단계 | 상태 | 예상 커버리지 |
|------|------|--------------|
| 1. 테스트 환경 설정 | 대기 | 5% |
| 2. 유틸 함수 테스트 | 대기 | 15% |
| 3. 스토어 테스트 | 대기 | 25% |
| 4. 커스텀 훅 테스트 | 대기 | 50% |
| 5. API 통합 테스트 | 대기 | 65% |
| 6. 컴포넌트 테스트 | 대기 | 80% |
| 7. E2E 테스트 | 대기 | 85% |
| 8. 코드 품질 개선 | 대기 | 90%+ |

- 시작일: 2025-11-21
- 현재 커버리지: 5.2%
- 목표 커버리지: 90%+

<br>

### 프리코스 피드백 적용 체크리스트

**1주차**
- [ ] 요구 사항 정확히 준수 (E2E 테스트로 검증)
- [ ] 기본적인 Git 명령어 숙지 (add, commit, push)
- [ ] Git으로 관리할 자원 고려 (.gitignore 설정)
- [ ] package-lock.json 역할 이해
- [ ] 커밋 메시지를 의미 있게 작성
- [ ] 이름을 통해 의도를 드러낸다 (좋은 네이밍)
- [ ] 축약하지 않는다 (줄임말 금지)
- [ ] 공백도 코딩 컨벤션이다
- [ ] 공백 라인을 의미 있게 사용한다
- [ ] 스페이스와 탭을 혼용하지 않는다
- [ ] 의미 없는 주석을 달지 않는다
- [ ] 코드 포매팅을 사용한다
- [ ] 디버거 사용 (console.log 대신)
- [ ] JavaScript에서 제공하는 API를 적극 활용한다

**2주차**
- [ ] README.md 상세 작성 (살아있는 문서)
- [ ] 기능 목록 재검토 (예외 상황 포함)
- [ ] 기능 목록 지속 업데이트
- [ ] 값을 하드 코딩하지 않는다 (상수 사용)
- [ ] 구현 순서도 코딩 컨벤션이다 (필드, 생성자, 메서드 순)
- [ ] 한 메서드가 한 가지 기능만 담당하게 한다
- [ ] 메서드 15라인 이하로 구현
- [ ] 테스트를 작성하는 이유 정리
- [ ] 처음부터 큰 단위의 테스트를 만들지 않는다
- [ ] JavaScript에서 객체를 만드는 다양한 방법 이해

**3주차**
- [ ] 함수 15라인 제한 (main 포함, 공백도 라인)
- [ ] 예외 상황에 대해 고민한다
- [ ] 비즈니스 로직과 UI 로직 분리 (SRP)
- [ ] 객체의 상태 접근을 제한한다 (private 필드)
- [ ] 객체는 객체답게 사용한다 (getter 대신 메시지 전달)
- [ ] 필드의 수를 줄이기 위해 노력한다
- [ ] 성공하는 케이스뿐만 아니라 예외 케이스도 테스트한다
- [ ] 테스트 코드도 코드다 (리팩터링, test.each 활용)
- [ ] 테스트를 위한 코드는 구현 코드에서 분리되어야 한다
